{*
/***************************************************************************
*                                games_reviews_add.html
*                            ---------------------------------
*   begin                : Tuesday, 29 August, 2017
*   copyright            : (C) 2017 Atari Legend
*   email                : martens_maarten@hotmail.com
*
*   Id: games_review_add.html,v 0.10 29/08/2017 20:25 STG
****************************************************************************/

//****************************************************************************************
// This is the reviews detail page
//****************************************************************************************
*}


{extends file='1/main/main.html'}
{block name=title}Add a review for {$game_info.game_name} (Atari ST) | Atari Legend{/block}

{block name=main_body}
    <!-- lightbox screenshot pop up script -->
    <script type="text/javascript" src="{$template_dir}includes/js/vendor/lightbox-2.9.0.min.js"></script>
    <link type="text/css" href="{$style_dir}css/vendor/lightbox-2.9.0.css" hreflang="en" rel="stylesheet">

    <script>
        lightbox.option({
            'showImageNumberLabel': false
        })
    </script>

    <script type="text/javascript"> <!-- all the code for the options of the textfield of the comment section -->
        var clientPC = navigator.userAgent.toLowerCase(); // Get client info
        var clientVer = parseInt(navigator.appVersion); // Get browser version

        var is_ie = ((clientPC.indexOf("msie") != -1) && (clientPC.indexOf("opera") == -1));
        var is_nav = ((clientPC.indexOf('mozilla')!=-1) && (clientPC.indexOf('spoofer')==-1)
                        && (clientPC.indexOf('compatible') == -1) && (clientPC.indexOf('opera')==-1)
                        && (clientPC.indexOf('webtv')==-1) && (clientPC.indexOf('hotjava')==-1));
        var is_moz = 0;

        var is_win = ((clientPC.indexOf("win")!=-1) || (clientPC.indexOf("16bit") != -1));
        var is_mac = (clientPC.indexOf("mac")!=-1);

        // Define the bbCode tags
        bbtags = new Array('[b]','[/b]','[i]','[/i]','[u]','[/u]','[url=www.yourlinkhere.com]','[/url]','[mail=your@mail.com]','[/mail]', '[hotspotUrl=#]', '[/hotspotUrl]', '[hotspot=]', '[/hotspot]','[screenstar]','[/screenstar]','[frontpage]','[/frontpage]' );
        bbcode = new Array();
        imageTag = false;

        function bbstyle(bbnumber, bbname) {

            var txtarea = eval('document.post.' + bbname);

            txtarea.focus();
            donotinsert = false;
            theSelection = false;
            bblast = 0;

            if (bbnumber == -1) { // Close all open tags & default button names
                while (bbcode[0]) {
                    butnumber = arraypop(bbcode) - 1;
                    txtarea.value += bbtags[butnumber + 1];
                    buttext = eval('document.post.addbbcode' + butnumber + '.value');
                    eval('document.post.addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
                }
                imageTag = false; // All tags are closed including image tags :D
                txtarea.focus();
                return;
            }

            if ((clientVer >= 4) && is_ie && is_win)
            {
                theSelection = document.selection.createRange().text; // Get text selection
                if (theSelection) {
                    // Add tags around selection
                    document.selection.createRange().text = bbtags[bbnumber] + theSelection + bbtags[bbnumber+1];
                    txtarea.focus();
                    theSelection = '';
                    return;
                }
            }
            else if (txtarea.selectionEnd && (txtarea.selectionEnd - txtarea.selectionStart > 0))
            {
                mozWrap(txtarea, bbtags[bbnumber], bbtags[bbnumber+1]);
                return;
            }

            // Find last occurance of an open tag the same as the one just clicked
            for (i = 0; i < bbcode.length; i++) {
                if (bbcode[i] == bbnumber+1) {
                    bblast = i;
                    donotinsert = true;
                }
            }

            if (donotinsert) {      // Close all open tags up to the one just clicked & default button names
                while (bbcode[bblast]) {
                        butnumber = arraypop(bbcode) - 1;
                        txtarea.value += bbtags[butnumber + 1];
                        buttext = eval('document.post.addbbcode' + butnumber + '.value');
                        eval('document.post.addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
                        imageTag = false;
                    }
                    txtarea.focus();
                    return;
            } else { // Open tags

                if (imageTag && (bbnumber != 14)) {     // Close image tag before adding another
                    txtarea.value += bbtags[15];
                    lastValue = arraypop(bbcode) - 1;   // Remove the close image tag from the list
                    document.post.addbbcode14.value = "Img";    // Return button back to normal state
                    imageTag = false;
                }

                // Open tag
                txtarea.value += bbtags[bbnumber];
                if ((bbnumber == 14) && (imageTag == false)) imageTag = 1; // Check to stop additional tags after an unclosed image tag
                arraypush(bbcode,bbnumber+1);
                eval('document.post.addbbcode'+bbnumber+'.value += "*"');
                txtarea.focus();
                return;
            }
            storeCaret(txtarea);
        }

        // From http://www.massless.org/mozedit/
        function mozWrap(txtarea, open, close)
        {
            var selLength = txtarea.textLength;
            var selStart = txtarea.selectionStart;
            var selEnd = txtarea.selectionEnd;
            if (selEnd == 1 || selEnd == 2)
                selEnd = selLength;

            var s1 = (txtarea.value).substring(0,selStart);
            var s2 = (txtarea.value).substring(selStart, selEnd)
            var s3 = (txtarea.value).substring(selEnd, selLength);
            txtarea.value = s1 + open + s2 + close + s3;
            return;
        }

        // Insert at Claret position. Code from
        // http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130
        function storeCaret(textEl) {
            if (textEl.createTextRange) textEl.caretPos = document.selection.createRange().duplicate();
        }
    </script>
    <script type="text/javascript">
        function openTab(evt, tabName)
        {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            //al the java code for the filling of the fields in the preview tab!
            if (tabName == 'preview')
            {
                //get the date field
                var day = document.getElementsByName("Date_Day")[0].value;
                document.getElementById("games_preview_review_date").innerHTML = day;
                document.getElementById("games_preview_review_date").innerHTML += '-';
                var month = document.getElementsByName("Date_Month")[0].value;
                document.getElementById("games_preview_review_date").innerHTML += month;
                document.getElementById("games_preview_review_date").innerHTML += '-';
                var year = document.getElementsByName("Date_Year")[0].value;
                document.getElementById("games_preview_review_date").innerHTML += year;

                //get the score
                {literal}
                //graphics
                var graphics = document.getElementsByName("graphics")[0].value;
                if(!isNaN(graphics)) {document.getElementById("games_preview_review_graphics").innerHTML = graphics;}
                else{document.getElementById("games_preview_review_graphics").innerHTML = 'please enter a number';}
                //sound
                var sound = document.getElementsByName("sound")[0].value;
                if(!isNaN(sound)) {document.getElementById("games_preview_review_sound").innerHTML = sound;}
                else{document.getElementById("games_preview_review_sound").innerHTML = 'please enter a number';}
                //gameplay
                var gameplay = document.getElementsByName("gameplay")[0].value;
                if(!isNaN(gameplay)) {document.getElementById("games_preview_review_gameplay").innerHTML = gameplay;}
                else{document.getElementById("games_preview_review_gameplay").innerHTML = 'please enter a number';}
                //overall
                var overall = document.getElementsByName("overall")[0].value;
                if(!isNaN(overall)) {document.getElementById("games_preview_review_overall").innerHTML = overall;}
                else{document.getElementById("games_preview_review_overall").innerHTML = 'please enter a number';}
                {/literal}

                //Do all the preps for the actual review text!
                var text = document.getElementById('game_review_textfield').value;
                text = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                text = text.replace(/\n\r?/g, '<br />');
                text = text.replaceAll("[b]", "<b>");
                text = text.replaceAll("[/b]", "</b>");
                text = text.replaceAll("[u]", "<u>");
                text = text.replaceAll("[/u]", "</u>");
                text = text.replaceAll("[i]", "<i>");
                text = text.replaceAll("[/i]", "</i>");
                text = text.replaceAll("[url=", "<a href=");
                text = text.replaceAll("[/url]", "</a>");
                text = text.replaceAll("[mail=", "<a href=mailto:");
                text = text.replaceAll("[/mail]", "</a>");
                text = text.replaceAll("]", " class=standard_tile_link_cpanel>");
                document.getElementById("games_preview_review_text").innerHTML = text;


                //get the screenshots data
                for (i = 0; i < {$nr_screenshots}; i++)
                {
                    var string = "comment_";
                    var string_comment = string.concat(i);
                    var comment = document.getElementById(string_comment).value;

                    if (comment == '')
                    {
                        var string3 = "output_";
                        var string_output = string3.concat(i);
                        var output = document.getElementById(string_output);
                        output.style.display='none';
                    }
                    else
                    {
                        var string2 = "preview_comment_";
                        var string_preview_comment = string2.concat(i);
                        document.getElementById(string_preview_comment).innerHTML = comment;

                        var string3 = "output_";
                        var string_output = string3.concat(i);
                        var output = document.getElementById(string_output);
                        output.style.display='inline';
                    }
                }
            }
        }
    </script>
    <script>
        {literal}
            String.prototype.replaceAll = function(str1, str2, ignore)
            {
                return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(/\$/g,"$$$$"):str2);
            }
        {/literal}
    </script>
    <script>
        function add_review()
        {
            var graphics = document.getElementsByName("graphics")[0].value;
            var sound = document.getElementsByName("sound")[0].value;
            var gameplay = document.getElementsByName("gameplay")[0].value;
            var overall = document.getElementsByName("overall")[0].value;

            if(!isNaN(graphics) && !isNaN(sound) && !isNaN(gameplay) && !isNaN(overall))
            {
                document.getElementById('post').method="post";
                document.getElementById('post').action="../games/db_games_reviews_add.php";
                document.getElementById('post').submit();
                return true;
            }
            else
            {
                alert("Please use only numeric values in the score field");
                return false;
            }

        }
    </script>
    <script type="text/javascript" src="{$template_dir}includes/js/vendor/jquery.dotdotdot-1.8.3.min.js" type="text/javascript"></script> <!--this script is used for the elipsis (...) effect of the latest reviews tile -->

    <div id="main" class="main_container_games_details">
        <div class="content_box_games_details" id="column_left_reviews_details">
            <!--*****************************-->
            <!--START Credits tile -->
            <!--*****************************-->
            <br>
            <div class="standard_tile">
                <h1>GAME REVIEWS</h1>
                <div class="standard_tile_line"></div>
                <div class="games_main_detail_comments_container">
                    <table class="standard_table_list_stats">
                        {if isset($reviews_author)}
                        <tr>
                            <td width="100%" colspan="2">
                                <div class="standard_list_entry_news_text" style="text-align:center;">
                                    {$user_session.userid} has written {$nr_reviews_author} additional reviews :
                                </div>
                            </td>
                        </tr>
                        {foreach from=$reviews_author item=line name=reviews_author}
                            <tr>
                                <td width="90%" style="padding-top:5px;padding-bottom:5px;">
                                    <span style="overflow: hidden;text-overflow: ellipsis"><a href="../games/games_detail.php?game_id={$line.game_id}" class="standard_tile_link" style="margin-left:10px;">{$line.game_name}</a></span>
                                    <br><span class="standard_tile_subtext" style="margin-left:15px;"><a href="../games/games_reviews_detail.php?review_id={$line.review_id}&game_id={$line.game_id}" style="margin-left:10px;">read more</a></span>
                                </td>

                                <td width="10%" style="padding-top:5px;padding-bottom:5px;">
                                    <a href="../games/games_main_list.php?year={$line.game_year}&amp;action=search" class="standard_tile_link" style="margin-right:10px;">{$line.game_year}</a>
                                    <br><br>
                                </td>
                            </tr>
                        {/foreach}
                        {else}
                            <tr>
                                <td width="100%">
                                    <div class="standard_list_entry_news_text" style="text-align:center;">
                                        You haven't written any reviews before. This is your first. Congratulations and good luck! For some examples, see tile 'Indepth reviews'.
                                    </div>
                                </td>
                            </tr>
                        {/if}
                    </table>
                </div>
            </div>
            <!--*****************************-->
            <!--END Credits tile             -->
            <!--*****************************-->
            {if isset($reviews_author)}
                <br>
                {include file='1/main/latest_comments_tile.html'}
            {else}
                <br>
                {include file='1/main/latest_reviews_tile.html'}
            {/if}
        </div>

        <div class="content_box_games_details" id="column_center_reviews_details">
            {if isset($user_session)}
            <br>
            <div class="standard_tile">
                <div class="help-tip">
                    <p>
                        This is the place were you write your own reviews. Some things to consider :
                        <br> - Make sure your review is worthy! A game review is more than an elaborate comment to a game (we have comments sections for this). See other reviews in the database as examples
                        <br> - You are not obliged to follow the common review structure (comments, graphics, sounds, gameplay, conclusion)
                        <br> - Your submitted review will be checked by our admin before it enters the database
                        <br> - The score input fields are obliged
                        <br> - Make sure to add some comments to the screenshots below to make the review more 'fun'. Every screenshot you comment, will be added to the review
                        <br> - Click the screenshots for a bigger version
                        <br> - Use the preview tab to see what your work looks like before you submit it
                        <br> - THANKS A LOT for you submission and for making this website more interesting for all of us!
                    </p>
                </div>
                <h1>{$game_info.game_name|upper}</h1>
                <div class="standard_tile_line"></div>
                <div class="tab">
                    <button class="tablinks" onclick="openTab(event, 'edit')" id="defaultOpen">EDIT</button>
                    <button class="tablinks" onclick="openTab(event, 'preview')">PREVIEW</button>
                </div>
                <div id="edit" class="tabcontent">
                    <!--**************************-->
                    <!--START Write a review tile -->
                    <!--**************************-->
                    <form id="post" onsubmit="return add_review();" name="post">
                        <div class="standard_tile_text">
                            <h6>
                                Written by : <br>
                                <select name="members" id="quick_search_pub_select">
                                    <option value="{$user_session.user_id}" selected>{$user_session.userid}</option>
                                </select>
                            </h6>
                            <br>
                            <h6>
                                <div style="width:20%;">Date :</div>
                                <div style="width:200px;">{html_select_date start_year="2000"}</div>
                            </h6>
                        </div>
                        <div class="standard_tile_text">
                            <h6>Review :</h6>
                            <div style="width:100%;text-align:left;margin-top:10px;">
                                <input type="button" accesskey= "b" name="addbbcode0" value="B" onclick="bbstyle(0,'textfield')" class="quick_search_games_button" style="min-width:20px;width:0;display:inline;" title="Bold">
                                <input type="button" accesskey= "u" name="addbbcode4" value="U" onclick="bbstyle(4,'textfield')" class="quick_search_games_button" style="min-width:20px;width:0;display:inline;" title="Underline">
                                <input type="button" accesskey= "i" name="addbbcode2" value="I" onclick="bbstyle(2,'textfield')" class="quick_search_games_button" style="min-width:20px;width:0;display:inline;" title="Recursive">
                                <input type="button" accesskey="w" name="addbbcode6" value="URL" onClick="bbstyle(6,'textfield')" class="quick_search_games_button" style="min-width:40px;width:0;display:inline;" title="Add links">
                                <input type="button" accesskey="x" name="addbbcode8" value="@" onClick="bbstyle(8,'textfield')" class="quick_search_games_button" style="min-width:20px;width:0;display:inline;" title="Add email address">
                                <textarea name="textfield" id="game_review_textfield" ONSELECT="javascript:storeCaret(this);" ONCLICK="javascript:storeCaret(this);" ONKEYUP="javascript:storeCaret(this);" ONCHANGE="javascript:storeCaret(this);" rows="15" placeholder="Review (required)" required></textarea>
                            </div>
                            <br>
                            <h6>Score :</h6>
                            <input type="text" name="graphics" class="standard_tile_input_small" style="width:22%;" placeholder="Graphics (required)" required>
                            <input type="text" name="sound" class="standard_tile_input_small" placeholder="Sound (required)" required style="width:22%;">
                            <input type="text" name="gameplay" class="standard_tile_input_small" placeholder="Gameplay (required)" required style="width:22%;">
                            <input type="text" name="overall" class="standard_tile_input_small" placeholder="Overall (required)" required style="width:22%;">
                        </div>
                        <br>
                        <div class="standard_tile_text" style="text-align:center;">
                            <h6>Screenshots</h6>
                            <br>
                            {if $nr_screenshots <> 0}
                                <table class="standard_table_games_main_detail">
                                {foreach from=$screenshots item=line}
                                    <tr>
                                        <td style="width:15%;border:0;">
                                            <a href="../../includes/show_image.php?file={$line.screenshot_image_pop}&amp;resize=410,null,null,null" data-lightbox="image-1">
                                                <img src="../../includes/show_image.php?file={$line.screenshot_image_pop}&amp;resize=75,null,null,null" alt="screenshot" style="display:inline; margin:5px;" class="game_screenshot_img">
                                            </a>
                                        </td>
                                        <td style="width:85%;border:0;">
                                            <input type="text" name="inputfield[]" id="comment_{$line.count}" class="standard_tile_input_small" style="width:95%;">
                                        </td>
                                    </tr>
                                {/foreach}
                                </table>
                            {else}
                                There are currently no screenshots attached to this game. Go to the<a href="../games/games_detail.php?game_id={$game.game_id}" class="left_nav_link"> screenshot adding</a>
                                page to link specific screenshots to this game.
                            {/if}
                            <br>
                            <br>
                            <br>
                            <input type="hidden" name="action" value="add_review">
                            <input type="hidden" name="game_id" value="{$game_info.game_id}">
                            <input type="submit" value="Add" class="quick_search_games_button" style="margin-bottom:10px;">
                        </div>
                    </form>
                    <!--**************************-->
                    <!--END Write a review tile -->
                    <!--**************************-->
                </div>
                <div id="preview" class="tabcontent">
                    <!--*********************-->
                    <!--START Preview tile -->
                    <!--*********************-->
                    <br>
                    <div class="standard_tile_text" id="games_detail_review_bg">
                        <h4 style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display:inline;">
                            Written by <a href="../../admin/user/user_detail.php?user_id_selected={$user_session.user_id}" class="standard_tile_link">{$user_session.userid}</a>
                        </h4>
                        <h5 style="font-weight: bold;"><div id="games_preview_review_date"></div></h5>
                        <br>
                        <br>
                        <div class="games_detail_review_container">
                            <div class="games_detail_review_child" id="games_detail_review_text">
                                <div id="games_preview_review_text"></div>
                                <br>
                                <b><i>Score</i></b>
                                <br>
                                <br>
                                Graphics : <span id="games_preview_review_graphics"></span><br>
                                Sound : <span id="games_preview_review_sound"></span><br>
                                Gameplay : <span id="games_preview_review_gameplay"></span><br>
                                Overall : <span id="games_preview_review_overall"></span><br>
                            </div>
                            <div class="games_detail_review_child" id="games_detail_review_screenshots">
                                <div class="games_detail_review_screenshot_space">
                                    <br>
                                    <br>
                                    <br>
                                </div>
                                {foreach from=$screenshots item=line}
                                    <div id="output_{$line.count}">
                                        <div class="games_detail_review_screenshot_order">
                                            <a href="../../includes/show_image.php?file={$line.screenshot_image_pop}&amp;resize=410,null,null,null" data-lightbox="image-1">
                                                <img src="../../includes/show_image.php?file={$line.screenshot_image_pop}&amp;resize=170,null,null,null" alt="Click to enlarge!" style="display:inline;" class="game_screenshot_img">
                                            </a>
                                            <br>
                                            <span class="standard_tile_subtext" style="font-weight: bold;" id="preview_comment_{$line.count}"></span>
                                            <br>
                                            <br>
                                            <br>
                                        </div>
                                    </div>
                                {/foreach}
                            </div>
                        </div>
                        <br>
                    </div>
                    <!--*********************-->
                    <!--END Preview tile -->
                    <!--*********************-->
                </div>
            </div>
            {else}
                <br>
                <div class="standard_tile">
                    <h1>{$game_info.game_name|upper}</h1>
                    <div class="standard_tile_line"></div>
                    <div class="standard_tile_text">
                        <h6>Please log in to use this page</h6>
                    </div>
                </div>
            {/if}
        </div>

        <div class="content_box_games_details" id="column_right_reviews_details">
            {if isset($reviews_author)}
                <br>
                {include file='1/admin/tile_user_contribution.html'}
            {else}
                <br>
                {include file='1/main/latest_comments_tile.html'}

                <script type="text/javascript">
                window.onload = function() {
                    $(".standard_list_entry_news_text").dotdotdot({  <!--This is the script to truncate the latest interviews-->
                            //  configuration goes here

                        /*  The text to add as ellipsis. */
                        ellipsis    : '... ',

                        /*  How to cut off the text/html: 'word'/'letter'/'children' */
                        wrap        : 'word',

                        /*  Wrap-option fallback to 'letter' for long words */
                        fallbackToLetter: false,

                        /*  jQuery-selector for the element to keep and put after the ellipsis. */
                        after       : null,

                        /*  Whether to update the ellipsis: true/'window' */
                        watch       : window,

                        /*  Optionally set a max-height, can be a number or function.
                            If null, the height will be measured. */
                        height      : null,

                        /*  Deviation for the height-option. */
                        tolerance   : 0,

                        /*  Callback function that is fired after the ellipsis is added,
                            receives two parameters: isTruncated(boolean), orgContent(string). */
                        callback    : function( isTruncated, orgContent ) {},

                        lastCharacter   : {

                            /*  Remove these characters from the end of the truncated text. */
                            remove      : [ ' ', ',', ';', '.', '!', '?' ],

                            /*  Don't add an ellipsis if this array contains
                                the last character of the truncated text. */
                            noEllipsis  : []
                        }
                    });
                };
                </script>
            {/if}
            <br>
            {include file='1/main/tile_bug_report.html'}
        </div>
    </div>
    <script>
        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();
    </script>
{/block}
